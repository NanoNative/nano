name: "Test"

permissions: {} # No permissions at workflow level - granted per job

on:
  # Test all branch pushes (except main branches)
  push:
    branches:
      - '*'        # All branches
      - '!main'    # Except main (deploy workflow handles main)
      - '!master'  # Except master
      - '!default' # Except default
    paths-ignore:
      - '*.md'
      - '*.cmd'
      - '*.bat'
      - '*.sh'
      - 'FUNDING.yml'
      - 'FUNDING.yaml'
      - '.editorconfig'
      - '.gitignore'
      - 'docs/**'

  # Test all pull requests
  pull_request:
    branches:
      - main
      - master
      - default
    paths-ignore:
      - '*.md'
      - '*.cmd'
      - '*.bat'
      - '*.sh'
      - 'FUNDING.yml'
      - 'FUNDING.yaml'
      - '.editorconfig'
      - '.gitignore'
      - 'docs/**'

  # Manual testing
  workflow_dispatch:
    inputs:
      run_test:
        type: boolean
        default: true
        required: false
        description: "Run tests (disable for build-only)"
      timeout_minutes:
        type: number
        default: 15
        required: false
        description: "Job timeout in minutes"

concurrency:
  group: test-${{ github.event_name }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: "ðŸ§ª Test [${{ github.event_name == 'pull_request' && format('PR #{0}', github.event.pull_request.number) || github.ref_name }}]"
    uses: ./.github/workflows/reusable_build_test.yml
    permissions:
      contents: read    # Read repository content for checkout
    with:
      ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.ref }}
      run_test: ${{ inputs.run_test != false }}
      timeout_minutes: ${{ inputs.timeout_minutes || 15 }}
